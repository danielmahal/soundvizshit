<!DOCTYPE html>
<html>
<head>
    <title>Equalizer</title>
    <style>
        body {
            margin: 0;
            background: black;
        }

        .eq {
            position: absolute;
            top: 0;
            right: 0;
            width: 200px;
            height: 100px;
            border: 1px red solid;
        }

        .eq .bar {
            background: white;
            float: left;
        }

        canvas {
            display: block;
        }
    </style>
</head>
<body>
    <canvas></canvas>

    <div class="eq"></div>

    <script>
        var canvas = document.querySelector('canvas');
        var graphics = canvas.getContext('2d');

        window.AudioContext = window.AudioContext || window.webkitAudioContext;

        var context = new window.AudioContext();

        var analyser = context.createAnalyser();
        analyser.fftSize = 2048;

        var request = new XMLHttpRequest();
        request.open('GET', 'sounds/01 A Brain In A Bottle.mp3', true);
        request.responseType = 'arraybuffer';

        var elements = [];

        var numBars = 20;
        var container = document.querySelector('.eq');
        var agents = [];

        var Agent = function(position) {
            this.position = position
            this.angle = Math.random() * Math.PI * 2
            this.speed = 0;
        }

        function setup() {
            canvas.width = window.innerWidth
            canvas.height = window.innerHeight

            for(var i = 0; i < numBars; i++) {
                var agent = new Agent({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height
                })

                agents.push(agent)
            }
        }

        function getSample(i, size) {
            var sum
            var data = new Uint8Array(1024);
            var binSize = Math.floor(data.length / size);

            for (var j = 0; j < binSize; j += 1) {
                sum += data[(i * binSize) + j];
            }

            analyser.getByteFrequencyData(data);

            return sum / size / 1024
        }

        function loop() {
            requestAnimationFrame(loop)

            graphics.clearRect(0, 0, canvas.width, canvas.height)
            graphics.fillStyle = 'white'

            var data = new Uint8Array(1024);
            var binSize = Math.floor(data.length / agents.length);

            analyser.getByteFrequencyData(data);

            agents.forEach(function(agent, i) {
                var sum = 0;

                for (var j = 0; j < binSize; j += 1) {
                    sum += data[(i * binSize) + j];
                }

                var average = sum / 10;
                var scaledAverage = average / 1024;

                agent.speed += scaledAverage * 10;
                agent.speed *= 0.6;

                agent.position.y += Math.sin(agent.angle) * agent.speed;
                agent.position.x += Math.cos(agent.angle) * agent.speed;

                agent.position.x = agent.position.x % window.innerWidth;
                agent.position.y = agent.position.y % window.innerHeight;

                graphics.beginPath()
                graphics.fillStyle = 'white'
                graphics.arc(agent.position.x, agent.position.y, 10, 0, Math.PI * 2)
                graphics.fill()
            })
        }

        setup()
        loop()
        console.log(agents)

        for(var i = 0; i < numBars; i++) {
            var element = document.createElement('div');

            container.appendChild(element);

            element.className = 'bar';
            element.style.width = (100 / numBars) + '%';

            elements.push(element);
        }

        var source = context.createBufferSource();

        request.onload = function() {
            context.decodeAudioData(request.response, function(buffer) {
                var source = context.createBufferSource();

                source.buffer = buffer;
                source.connect(context.destination);
                source.start(0);

                source.connect(analyser);
                analyser.connect(context.destination);

                paintThatShitGold();
            }, function(err) {
                // console.log('Error', err)
            });
        }

        function paintThatShitGold() {
            requestAnimationFrame(paintThatShitGold);

            var data = new Uint8Array(1024);
            var binSize = Math.floor(data.length / numBars);

            analyser.getByteFrequencyData(data);

            for (var i = 0; i < numBars; i += 1) {
                var sum = 0;

                for (var j = 0; j < binSize; j += 1) {
                    sum += data[(i * binSize) + j];
                }

                var average = sum / 10;
                var scaledAverage = average / 1024;

                var angle = i / (numBars / Math.PI / 2) - Math.PI;
                var x = Math.sin(angle) * 100;
                var y = Math.cos(angle) * 100;
                var rotation = angle * (180 / Math.PI);

                elements[i].style.height = scaledAverage * 100 + '%';
                // elements[i].style.webkitTransform = 'translate3d('+x+'px, '+y+'px, 0) rotateZ('+(-rotation)+'deg)';
            }
        }

        request.send();
    </script>
</body>
</html>